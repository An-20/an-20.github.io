<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EH&S V3</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manjari&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro&family=Manjari&display=swap" rel="stylesheet">

  <!-- <link rel="stylesheet" href="vendor/leaflet/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/> -->
  <link rel="stylesheet" href="vendor/leaflet/leaflet.css" crossorigin=""/>
  <script src="vendor/leaflet/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="vendor/jquery/jquery-3.7.1.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style> 
    html, body {
      font-family: 'Manjari', sans-serif;
      color: white;
      background: #202020;
      font-size: 25px;
      margin: 0px;
      height: 100%;
      display: flex;
      flex-flow: column;
    }

    section {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 30px;
      padding: 0px 20vw;
      margin: 0px;
    }

    .bg1 {
      background: #0462aa;
      text-align: center;
      flex: 1 1 auto;
    }

    .bg2 {
      background: #b75300;
    }

    .spacer {
      aspect-ratio: 1000/300;
      width: 100%;
      margin: 0px;
      background-repeat: no-repeat;
      background-position: center;
      background-size: cover;
      min-height: 50px;
    }

    .transition1 {
      background-image: url('./images/transition-e1.svg');
    }

    .links {
      font-family: 'Anonymous Pro', monospace;
      text-align: center;
    }

    #map {
      height: 90vh;
      width: 90vw;

      position: absolute;
      top: 7vh;

      border-radius: 10px;
    }

    h4 {
      padding: 0px;
    }

    #homelink {
      position: absolute;
      top: 8px;
      left: 8px;

      font-size: 20px;
      text-decoration: underline;
      color: #81cfff;
    }

    #status {
      width: 100%;
      position: absolute;
      top: 0px;
      left: 0px;
      z-index: 1000;
      background-color: #202020;
      opacity: 60%;
      border-top-right-radius: 10px;
      text-align: left;
      padding: 0px 5px 0px 5px;
    }

  </style>

</head>
<body>
  <section class="bg1">
    <a id="homelink" href="index.html">â†© Back to homepage</a>

    <h4>Exeter H&S V3 Map</h4>
    <div id="map">
      <div id="status">NULL</div>
    </div>
  </section>

  <div class="spacer transition1"></div>

  <section class="bg2 links">
  </section>
</body>

<script>
    var map = L.map('map', {zoomControl: false, attributionControl: false}).setView([50.72452, -3.52802], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        // attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // L.marker([51.5, -0.09]).addTo(map)
    //     .bindPopup('A pretty CSS popup.<br> Easily customizable.')
    //     .openPopup();

    const zone_5_latlong = [[50.725234746054895, -3.52777353435917], [50.72443375094036, -3.52945386725105], [50.72410175544749, -3.529052988111289], [50.72378693560651, -3.5285689203611525], [50.72331073298275, -3.527755933252706], [50.72328217232891, -3.5275193107304688], [50.72345237025408, -3.527383966331058], [50.724142649520815, -3.5272661379993338], [50.72418170112235, -3.5272504859261176], [50.72420967836871, -3.5272127368081385], [50.724635891033756, -3.527157824691784], [50.724718361112224, -3.5272111833325823], [50.725234746054895, -3.52777353435917]];

    const zone_4_latlong = [[50.72551752835892, -3.5269744606274287], [50.726037009205925, -3.5275542448896715], [50.725814615373224, -3.527954768081514], [50.725692345367634, -3.528206107388769], [50.725603640748346, -3.5283029592269486], [50.725273765004516, -3.5289973369569907], [50.72530376826782, -3.529207526052147], [50.72523507513867, -3.5294412461293234], [50.725261817200845, -3.529732831981704], [50.725312040055854, -3.529724589272746], [50.725321823722936, -3.5298358658520783], [50.72523833636646, -3.5298925344805525], [50.72524224983957, -3.529940960400097], [50.72508704570757, -3.5301350748521827], [50.72484152157048, -3.5306359272213683], [50.72498837873894, -3.5308077684115915], [50.72508900282935, -3.5309924976911304], [50.72517466911464, -3.5313297360279137], [50.72517602889587, -3.531581053768633], [50.72507132563979, -3.5317335628260196], [50.72510260102342, -3.531785114187585], [50.72482248485656, -3.5323285619528804], [50.72375773522077, -3.530888929867814], [50.72369960652392, -3.530660891471939], [50.72332914015942, -3.5300563059693104], [50.72346862332083, -3.530084508207864], [50.72359694746345, -3.5298888551737946], [50.7237453566851, -3.5295574788631257], [50.72309815556514, -3.5283553614837615], [50.72307574001846, -3.5281832135195543], [50.723089130492355, -3.527827160249956], [50.722996512969274, -3.527263115465729], [50.72326543796569, -3.5271785086187606], [50.72367942334023, -3.5270639370222057], [50.724027595291005, -3.526966595786689], [50.72413649576444, -3.5269280830486025], [50.72427648362273, -3.526924386691377], [50.72429819340974, -3.5269543937681647], [50.724610270482, -3.526991545386693], [50.72462745727495, -3.5269772563032404], [50.72483405614622, -3.526746354169518], [50.72506796837163, -3.5263166738033647], [50.72521544583367, -3.5266380211461694], [50.72551752835892, -3.5269744606274287]]

    const zone_3_latlong = [[50.724945869047616, -3.525530297301998], [50.72498386817034, -3.5260636733620174], [50.72521998561862, -3.526617671321958], [50.725555062013655, -3.5269934026117085], [50.72598562298228, -3.52749254928915], [50.726018609345005, -3.5274596385194457], [50.726034663696595, -3.5275629234840835], [50.725815556158636, -3.5279624136927623], [50.72569182902606, -3.528198303220023], [50.725615032710095, -3.528298050791392], [50.725335914329946, -3.5288914537936478], [50.72526253062924, -3.5289750260832307], [50.72532823464573, -3.52920821972981], [50.72522943296036, -3.5294465198084595], [50.72526519393057, -3.5297307675191405], [50.725313442815576, -3.5297280774773014], [50.72532706602098, -3.5298249189689557], [50.72532138968552, -3.529841059217432], [50.72523794747974, -3.5299002401292796], [50.725246461997585, -3.5299370040284543], [50.72507390246483, -3.530167134711263], [50.72483367592619, -3.5306305364028105], [50.72499305713251, -3.5308239245104858], [50.72504618408061, -3.5309260918126597], [50.72510624055863, -3.5310519765243953], [50.725172071608796, -3.5313274633573712], [50.72519632513075, -3.5315208514642507], [50.7250580171289, -3.5317073856925845], [50.72509612989313, -3.531802255330007], [50.72487091765615, -3.532216397787721], [50.72479007197407, -3.5322583593577406], [50.723587114438374, -3.5343148281606034], [50.72258252538404, -3.532574051568332], [50.72243088089388, -3.5323569723623223], [50.72203862367087, -3.5319600090420806], [50.720172619653454, -3.529695465110393], [50.720075226409875, -3.529480098510845], [50.72001159604824, -3.5291478186139216], [50.7201479467175, -3.5284196743955647], [50.72037389838249, -3.528181745580298], [50.72059959963374, -3.5280206204326134], [50.721491703180504, -3.527191973861818], [50.72265323003188, -3.5263597378786358], [50.723127168599945, -3.5262394366381784], [50.72396310242473, -3.5261148430556943], [50.72429015076543, -3.5261148637867734], [50.7244057136638, -3.526026666036529], [50.72432391074284, -3.5257005394710745], [50.72456022990244, -3.5255979839472786], [50.724701761136004, -3.5255405528540393], [50.724945869047616, -3.525530297301998]];
    
    const zone_2_latlong = [[50.72015001975279, -3.5283982912496015], [50.72027573269321, -3.5282175620077965], [50.72088872504045, -3.5277755544998115], [50.72146484465347, -3.5271993984428036], [50.72217749430962, -3.5266338445923395], [50.722658072218564, -3.5263422460612617], [50.72308315751104, -3.5262535473131322], [50.72286023026345, -3.5252626351560252], [50.7226778125752, -3.524237168404568], [50.72277861061616, -3.5242395411486314], [50.724572281829694, -3.52336394495444], [50.724898287937265, -3.523064532161726], [50.7251255081693, -3.522955932707646], [50.72520306583539, -3.5230250509918903], [50.725338517716494, -3.5230332106249023], [50.725425283390905, -3.522987411317729], [50.725511459857046, -3.5228926972754095], [50.72555898545167, -3.5226402051839614], [50.725543469875504, -3.522470376987002], [50.72560133425475, -3.5223685046747732], [50.725663698192534, -3.5222269324564195], [50.72650285094028, -3.521243245548419], [50.72681242647036, -3.521856823045283], [50.727235970062395, -3.52253684805234], [50.727586682218174, -3.523043853000644], [50.72774908357488, -3.5232848925961093], [50.727953837329295, -3.5235094174977917], [50.728177614655664, -3.5238451983479706], [50.728297699749675, -3.52406270170772], [50.72819139811736, -3.5242351532162957], [50.72793359584438, -3.524765670199457], [50.72774042844509, -3.5249362896604737], [50.72753971257214, -3.5251316782529045], [50.72735503064919, -3.525495370795852], [50.72723030411754, -3.5256169772358987], [50.726934027882095, -3.52557770526613], [50.72694677985555, -3.5257477332947076], [50.72706140090659, -3.5261483805186344], [50.7265106648731, -3.526620080734716], [50.726563312343785, -3.526698973897453], [50.726645229319814, -3.526787693647236], [50.72671693790761, -3.5271789919064247], [50.7261874134833, -3.5273343420247727], [50.72608375740933, -3.52745962875116], [50.72618426483564, -3.527528821860443], [50.72666147076737, -3.5280536157362405], [50.72689735022317, -3.5284365719341224], [50.72724938944273, -3.529210674916669], [50.72753747464529, -3.529688175004992], [50.72750207123002, -3.529886935247191], [50.72753263468971, -3.530184841795915], [50.72731955140361, -3.5308054434959217], [50.727074995130266, -3.531489422564931], [50.72678231647927, -3.532135405661336], [50.72641043541299, -3.5326728320243603], [50.725570208993474, -3.5329428630269035], [50.72537079508618, -3.5330011873723777], [50.72483423702502, -3.5323058795355564], [50.72358810064296, -3.5344464889040523], [50.722901124703526, -3.535732499400524], [50.72249186195836, -3.5361535503493258], [50.72239030991258, -3.536153523021113], [50.72205017229291, -3.5356796346746364], [50.72176601829008, -3.5360135075070787], [50.7213325501574, -3.5364319915561566], [50.721065958028106, -3.536633198559258], [50.72084922888726, -3.5367235107000567], [50.72063775082134, -3.536566259157979], [50.720336833212116, -3.5360828095298587], [50.72011838827635, -3.5356594466800573], [50.719937593810556, -3.535195322239133], [50.71977986861029, -3.5347109285230545], [50.71968238666361, -3.5344803682199597], [50.71959599239739, -3.533817365044058], [50.719609245468405, -3.53337378166043], [50.719691653220195, -3.532721437437516], [50.71979872263037, -3.5322775274584615], [50.7199533075117, -3.531603237764557], [50.71999066848005, -3.5309862612160714], [50.71993920533865, -3.530513993642387], [50.71984053772201, -3.530144205944822], [50.71983474414091, -3.5296978244300874], [50.719862088949185, -3.529580707519159], [50.720012831807, -3.5291437518402233], [50.72015001975279, -3.5283982912496015]];

    const zone_1_latlong = [[50.71824150406263, -3.5315453152475698], [50.71835545804373, -3.531273385240411], [50.718300564304, -3.5306731426381077], [50.718119354341724, -3.5300672624991023], [50.717545135283586, -3.529292242303171], [50.716498472446716, -3.527779303940946], [50.71688738480867, -3.527725712119434], [50.71720843083662, -3.527585548891693], [50.71740418952993, -3.5275319570702095], [50.71752425445791, -3.5276102835786958], [50.717949699442784, -3.5275525693087673], [50.718189826195555, -3.527358814260481], [50.71831249917062, -3.5271774265547435], [50.71847693265488, -3.5269342021315992], [50.718933689153204, -3.5276144071034707], [50.719270381205405, -3.527222774557515], [50.719473961272854, -3.526732203262725], [50.719607070838634, -3.526373550299752], [50.71986806889018, -3.526196285042488], [50.72030393239541, -3.5261756728030207], [50.72033525177244, -3.5259077136928454], [50.720481408589194, -3.5248193874594733], [50.72070345447378, -3.524408315718148], [50.72117393512531, -3.5242596876611003], [50.721472737935585, -3.524294066783142], [50.721907455086836, -3.5243446003231327], [50.72252615499008, -3.524262453658821], [50.72285171544067, -3.5241703042635493], [50.72376235840508, -3.5237706232776986], [50.72459599246761, -3.5233396019129373], [50.724882254445475, -3.5230678625740097], [50.72511182911913, -3.5228033046330722], [50.72514570069686, -3.522853838171727], [50.72522661603412, -3.5229281522003077], [50.72532446695243, -3.5229281522003077], [50.72542419940913, -3.5228687009782504], [50.72547500642824, -3.5227765515829503], [50.72548629686938, -3.52259522535266], [50.72546936120668, -3.5224317344903397], [50.72537903756853, -3.5222949966782267], [50.725394091519945, -3.5221701491096837], [50.725705491139564, -3.5219915868140106], [50.726411135013365, -3.521022531882693], [50.726563553363604, -3.5211919633844673], [50.72705586172435, -3.5221545084417016], [50.72760530816677, -3.5212330144888426], [50.72774464200603, -3.5211419361440335], [50.72803441509711, -3.5211270733375386], [50.72818494586579, -3.5212786739562034], [50.72821128870055, -3.521439192258214], [50.72833547615082, -3.5216978050773378], [50.728903723616895, -3.5222239483989313], [50.72800995380183, -3.523505122250924], [50.72816424791378, -3.5237399545801793], [50.7284280386946, -3.5241338897235153], [50.72869356476289, -3.524720341247786], [50.728884330136054, -3.5251642524707165], [50.729082828415784, -3.5256936878736838], [50.72917821040659, -3.5262353410176104], [50.72847804348342, -3.5264570393880206], [50.727547402393355, -3.5269172409315956], [50.72621937437452, -3.527314692264838], [50.72608013761692, -3.527476239978512], [50.72621205582061, -3.5275579939492445], [50.72662258572694, -3.527986538006985], [50.7269026545346, -3.528433780315737], [50.72725606476962, -3.529234401944308], [50.72748336404504, -3.5297425589763236], [50.727607896423535, -3.5300705413677633], [50.727400751695654, -3.530549319165033], [50.72710602070535, -3.53140145579556], [50.72681009077752, -3.5321915602896183], [50.7264409681535, -3.5326680253409393], [50.72578197808542, -3.5329118066970295], [50.72547611456724, -3.532935965209276], [50.72541279180609, -3.5330735857536126], [50.72484512489294, -3.533828199639032], [50.72441864759759, -3.5343185049161434], [50.72381175646663, -3.534959864164165], [50.72358028490444, -3.534459296142444], [50.72309724659223, -3.535548277989392], [50.72247826124541, -3.536326908268279], [50.7220460332515, -3.535680102683841], [50.7215009101333, -3.5363167732936915], [50.7210135398351, -3.5366633180633755], [50.72078370609424, -3.5367381131781883], [50.72064280243933, -3.536588522948648], [50.72013912434139, -3.5357177092377867], [50.719625163386695, -3.5364127564546095], [50.71966327753961, -3.536542279701706], [50.71962631836112, -3.536907133919499], [50.719429952989344, -3.5376091813146786], [50.71949248282843, -3.538251153202026], [50.71907665783252, -3.5385301640613136], [50.718798396940485, -3.53768819323858], [50.718615494218085, -3.53696474030329], [50.71807545665786, -3.535997589999454], [50.717731607292905, -3.5354317248694827], [50.71754068731522, -3.534796128348461], [50.71744732320644, -3.533878995144022], [50.71751943354329, -3.533280760610012], [50.71800756859301, -3.5322168381613324], [50.71824150406263, -3.5315453152475698]];

    var zone_1 = L.polygon(zone_1_latlong, {color: 'purple', fillOpacity: 0.15}).addTo(map);
    var zone_2 = L.polygon(zone_2_latlong, {color: 'blue', fillOpacity: 0.15}).addTo(map);
    var zone_3 = L.polygon(zone_3_latlong, {color: 'green', fillOpacity: 0.15}).addTo(map);
    var zone_4 = L.polygon(zone_4_latlong, {color: 'orange', fillOpacity: 0.15}).addTo(map);
    var zone_5 = L.polygon(zone_5_latlong, {color: 'red', fillOpacity: 0.15}).addTo(map);

    // placeholders for the L.marker and L.circle representing user's current position and accuracy    
    var current_position, current_accuracy;

    current_position = L.marker([0, 0]).addTo(map);
    current_accuracy = L.circle([0, 0], 0).addTo(map);

    function onLocationFound(e) {
      // if position defined, then remove the existing position marker and accuracy circle from the map
      if (current_position) {
          map.removeLayer(current_position);
          map.removeLayer(current_accuracy);
      }

      var radius = e.accuracy / 2;
      
      // current_position = L.marker([50.7244633509844, -3.529617726602998]).addTo(map);
      current_position = L.marker(e.latlng).addTo(map);
      current_accuracy = L.circle(e.latlng, radius, {weight: 1, opacity: 0.5, fillOpacity: 0.2}).addTo(map);
    }

    function onLocationError(e) {
      alert(e.message);
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    map.locate({setView: true, maxZoom: 16});
    locate();

    function isMarkerInsidePolygon(marker, poly) {
      var polyPoints = poly.getLatLngs()[0];       
      var x = marker.getLatLng().lat, y = marker.getLatLng().lng;
      console.log(x, y);

      var inside = false;
      for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
          var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
          var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

          var intersect = ((yi > y) != (yj > y))
              && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
      }

      return inside;
  };

    // wrap map.locate in a function    
    function locate() {
      map.locate(current_position.getLatLng());
      var zone = "N/A";

      if (isMarkerInsidePolygon(current_position, zone_1)) {
        zone = 1;
      }
      if (isMarkerInsidePolygon(current_position, zone_2)) {
        zone = 2;
      }
      if (isMarkerInsidePolygon(current_position, zone_3)) {
        zone = 3;
      }
      if (isMarkerInsidePolygon(current_position, zone_4)) {
        zone = 4;
      }
      if (isMarkerInsidePolygon(current_position, zone_5)) {
        zone = 5;
      }
      
      var latlng = current_position.getLatLng();
      $("#status").text(`CP: ${latlng.lat}, ${latlng.lng} | CZ: ${zone}`);
    }

    // call locate every 3 seconds... forever
    setInterval(locate, 3000);

    // leaflet uses latlong while geojson is longlat. go figure.
    function reverse_latlong(x) {
      var new_arr = [];
      x.forEach(element => {
        new_arr.push([element[1], element[0]])
      });
      return new_arr;
    }
</script>

</html>
